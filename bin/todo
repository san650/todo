#!/usr/bin/env bash

COMMAND="$1"
shift

FILE=${TODO_FILE:-$HOME/.todo}
FILTER="$TODO_FILTER"

if [ ! -f "$FILE" ]; then
  touch "$FILE"
fi

function print_all
{
  cat -n $FILE
}

function print_pending
{
  if [ ! -z "$FILTER" ]; then
    echo "Filtering by: $FILTER"
    echo
  fi

  cat -n $FILE | sed -n '/- \[ \]/p' | grep "$FILTER"
}

case $COMMAND in
  "")
    print_pending
    ;;
  add)
    MESSAGE="$@"
    echo "- [ ] $MESSAGE" >> $FILE
    ;;
  all)
    print_all
    ;;
  "done")
    sed -i '' "$1s/\[ \]/[x]/" $FILE
    ;;
  undone)
    sed -i '' "$1s/\[x\]/[ ]/" $FILE
    ;;
  filter)
    print_pending | grep "$1"
    ;;
  edit)
    if [ ! -z "$1" ] && [ ! -z "$2" ]; then
      LINE=$1
      shift
      MESSAGE="$@"

      sed -i '' "${LINE}c\\
- [ ] $MESSAGE
" $FILE
    else
      vim $FILE
    fi
    ;;
  raw)
    cat $FILE
    ;;
  *)
    echo "Error: command '$COMMAND' unknown

    Usage:
        todo add [message]
        todo done [n]
        todo undone [n]"
    exit 1
    ;;
esac
